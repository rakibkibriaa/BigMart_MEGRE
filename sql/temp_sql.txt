


CREATE OR REPLACE PROCEDURE UPDATE_TOTAL_PURCHASE(C_ID IN VARCHAR2)
IS

CNTT NUMBER;
FOUND NUMBER;
BEGIN
	
	FOR R IN
	(
		SELECT C.PRODUCT_ID AS PRODUCT_ID, C.QUANTITY AS QUANTITY
		FROM CART C JOIN PRODUCT P
		ON C.PRODUCT_ID = P.PRODUCT_ID
		WHERE C.CART_ID = C_ID
	)
	LOOP
		
		BEGIN
			
			SELECT COUNT(*) INTO CNTT
			FROM TOTAL_PURCHASE;
			
			IF(CNTT > 0) THEN
			
				FOR K IN
				(
					SELECT PRODUCT_ID
					FROM TOTAL_PURCHASE
				)
				
				LOOP 
				  IF(K.PRODUCT_ID = R.PRODUCT_ID) THEN
							FOUND := 1;
					END IF;
				END LOOP;
				
				IF(FOUND = 1) THEN
					UPDATE TOTAL_PURCHASE SET CNT = CNT + R.QUANTITY
					WHERE PRODUCT_ID = R.PRODUCT_ID;
				ELSE
					INSERT INTO TOTAL_PURCHASE VALUES(R.PRODUCT_ID,R.QUANTITY);
				END IF;
				
			ELSE
				INSERT INTO TOTAL_PURCHASE VALUES(R.PRODUCT_ID,R.QUANTITY);
			END IF;
			
		END;
		
	END LOOP;
END;
/

BEGIN
	UPDATE_TOTAL_PURCHASE('1');
END;





CREATE OR REPLACE TRIGGER ORDER_TRIGGER
AFTER INSERT
ON ORDER_TABLE
FOR EACH ROW
DECLARE

O_ID VARCHAR2(100);
P_ID VARCHAR2(100);

BEGIN
	
	O_ID := :NEW.ORDER_ID;
	P_ID := :NEW.PERSON_ID;
	
	UPDATE CART SET CART_ID = O_ID 
	WHERE CART_ID IS NULL
	AND PERSON_ID = P_ID;
	
	

END;
/






CREATE OR REPLACE TRIGGER UPDATE_PRODUCT_TABLE
AFTER UPDATE
ON CART
FOR EACH ROW
DECLARE

QUAN NUMBER;
PRO_ID VARCHAR2(100);

BEGIN

	QUAN := :OLD.QUANTITY;
	PRO_ID := :OLD.PRODUCT_ID;
	
	IF(:NEW.CART_ID IS NOT NULL) THEN
		UPDATE PRODUCT SET QUANTITY = QUANTITY - QUAN, TOTAL_SALES = TOTAL_SALES + QUAN
		WHERE PRODUCT_ID = PRO_ID;
	END IF;
END;
/

--ALTER TRIGGER UPDATE_PRODUCT_TABLE DISABLE;


CREATE OR REPLACE TRIGGER ADD_SUBSCRIPTION_MODEL
AFTER INSERT
ON SUBSCRIPTION_PLAN
FOR EACH ROW
DECLARE
BEGIN
	INSERT INTO SUBSCRIPTION (SUBSCRIPTION_ID) VALUES (:NEW.SUBSCRIPTION_ID);
	INSERT INTO SUBSCRIPTION_HAS_BUNDLE (SUBSCRIPTION_ID) VALUES (:NEW.SUBSCRIPTION_ID);
END;
/



CREATE OR REPLACE TRIGGER DELETE_SUBSCRIPTION_MODEL
BEFORE DELETE
ON SUBSCRIPTION_PLAN
FOR EACH ROW
DECLARE
BEGIN
	DELETE FROM SUBSCRIPTION WHERE SUBSCRIPTION_ID = :OLD.SUBSCRIPTION_ID;
	DELETE FROM SUBSCRIPTION_HAS_BUNDLE WHERE SUBSCRIPTION_ID = :OLD.SUBSCRIPTION_ID;
END;
/






CREATE OR REPLACE PROCEDURE ADD_BUNDLE_TO_SUBSCRIPTION (S_ID IN VARCHAR2,B_ID IN VARCHAR2,DISCOUNT IN NUMBER)
IS
FOUND NUMBER;

BEGIN

FOUND := 0;

FOR R IN(SELECT BUNDLE_ID FROM SUBSCRIPTION_HAS_BUNDLE WHERE SUBSCRIPTION_ID = S_ID)
	
	LOOP
	
		DBMS_OUTPUT.PUT_LINE(R.BUNDLE_ID);

		IF R.BUNDLE_ID IS NULL THEN
		
			FOUND := 1;
			
			EXIT; 
			
		END IF; 

	END LOOP;

IF(FOUND = 1) THEN
	BEGIN
		UPDATE SUBSCRIPTION_HAS_BUNDLE SET BUNDLE_ID = B_ID
		WHERE SUBSCRIPTION_ID = S_ID AND BUNDLE_ID IS NULL;
	    INSERT INTO BUNDLE_SUBSCRIPTION VALUES (B_ID, DISCOUNT);
	END;
ELSE 
	BEGIN
		INSERT INTO SUBSCRIPTION_HAS_BUNDLE VALUES (S_ID, B_ID);
		INSERT INTO BUNDLE_SUBSCRIPTION VALUES (B_ID, DISCOUNT);
	END;
END IF;

END;
/

BEGIN
	ADD_BUNDLE_TO_SUBSCRIPTION('a2220e5ed861756ebaeae4d10c9666d3','100');
END;





CREATE OR REPLACE PROCEDURE ADD_USER_TO_SUBSCRIPTION (S_ID IN VARCHAR2,B_ID IN VARCHAR2)
IS

FOUND NUMBER;

BEGIN

FOUND := 0;

FOR R IN(SELECT BUYER_ID FROM SUBSCRIPTION WHERE SUBSCRIPTION_ID = S_ID)
	
	LOOP
	

		IF R.BUYER_ID IS NULL THEN
		
			FOUND := 1;
			
			EXIT; 
			
		END IF; 

	END LOOP;

IF(FOUND = 1) THEN
	BEGIN
		UPDATE SUBSCRIPTION SET BUYER_ID = B_ID
		WHERE SUBSCRIPTION_ID = S_ID AND BUYER_ID IS NULL;
	END;
ELSE 
	BEGIN
		INSERT INTO SUBSCRIPTION VALUES (S_ID, B_ID);
	END;
END IF;

END;
/


DROP TRIGGER DELETE_BUNDLE
CREATE OR REPLACE TRIGGER DELETE_BUNDLE
BEFORE UPDATE 
ON SUBSCRIPTION_HAS_BUNDLE
FOR EACH ROW
DECLARE

BEGIN
	
		IF(:NEW.BUNDLE_ID IS NULL) THEN
		
			BEGIN
			
				DELETE FROM BUNDLE_DISCOUNT 
				WHERE BUNDLE_ID = :OLD.BUNDLE_ID;
				
			END;
			
			BEGIN
			
				DELETE FROM BUNDLE 
				WHERE BUNDLE_ID = :OLD.BUNDLE_ID;
				
			END;
		
		 END IF;
END;
/


CREATE OR REPLACE PROCEDURE ADD_REVIEW(MSG IN VARCHAR2,R_ID IN VARCHAR2,P_ID IN VARCHAR2,PRO_ID IN VARCHAR2)
IS

BEGIN
	INSERT INTO PRODUCT_REVIEW VALUES(R_ID,PRO_ID);
  	INSERT INTO PERSON_REVIEW VALUES(R_ID,P_ID);
 	INSERT INTO REVIEW VALUES(R_ID,MSG);
END;
/


CREATE OR REPLACE TRIGGER DELETE_REVIEW
BEFORE DELETE 
ON PERSON_REVIEW
FOR EACH ROW
DECLARE

BEGIN
		DELETE FROM PRODUCT_REVIEW WHERE REVIEW_ID = :OLD.REVIEW_ID;
		DELETE FROM REVIEW WHERE REVIEW_ID = :OLD.REVIEW_ID;
END;
/

DELETE FROM PERSON_REVIEW WHERE REVIEW_ID = 'fe7e49f70176fa8e4dc2b7e0e54de225'


CREATE OR REPLACE TRIGGER BAN_ITEM
BEFORE DELETE 
ON PRODUCT
FOR EACH ROW
DECLARE

BEGIN
		DELETE FROM BUNDLE WHERE PRODUCT_ID = :OLD.PRODUCT_ID;
		DELETE FROM CART WHERE PRODUCT_ID = :OLD.PRODUCT_ID;
		
		DELETE FROM COMPLAIN WHERE PRODUCT_ID = :OLD.PRODUCT_ID;
		
		DELETE FROM PRODUCT_REVIEW WHERE PRODUCT_ID = :OLD.PRODUCT_ID;
		DELETE FROM IMAGE WHERE PRODUCT_ID = :OLD.PRODUCT_ID;
		
		DELETE FROM STORAGE WHERE PRODUCT_ID = :OLD.PRODUCT_ID;
		DELETE FROM WISHLIST WHERE PRODUCT_ID = :OLD.PRODUCT_ID;
END;
/

CREATE OR REPLACE TRIGGER BAN_SELLER
BEFORE DELETE 
ON SELLER
FOR EACH ROW
DECLARE

BEGIN
		DELETE FROM PRODUCT P.PRODUCT_ID IN 
		(
			SELECT P.PRODUCT_ID
			FROM STORAGE S JOIN PRODUCT P
			ON (S.PRODUCT_ID = P.PRODUCT_ID)
			AND S.SELLER_ID = :OLD.SELLER_ID
		);
END;
/


CREATE OR REPLACE PROCEDURE UPDATE_PICTURE (CTG IN VARCHAR2,IMG IN VARCHAR2)
IS

FOUND NUMBER;

BEGIN

FOUND := 0;


SELECT COUNT(*) INTO FOUND FROM CATEGORY_IMAGE WHERE CATEGORY = CTG;

IF(FOUND = 0) THEN
	
	INSERT INTO CATEGORY_IMAGE VALUES(CTG,IMG);

ELSE

	 UPDATE CATEGORY_IMAGE SET IMAGE_SRC = IMG WHERE CATEGORY = CTG;
	 
END IF;

END;
/